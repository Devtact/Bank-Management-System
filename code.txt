#include <iostream>
#include <conio.h>
#include <windows.h>
#include <mysql.h>
#include <cstdlib>
#include <string>
#include <sstream>
#include <time.h>
#include <stdio.h>
#include<stdlib.h>


#define SSTR( x ) static_cast< std::ostringstream & >( \
        ( std::ostringstream() << std::dec << x ) ).str()

using namespace std;

string starp(int p,string s)
{
    string sk;
    for(int i=0;i<=p;i++)
    {
        sk+=s;
    }
    return sk;
}


class suno
{
public:
    static string query;
    static string dat;

    string nam,addr,rec;
    int bal,ac,amm;

    int qstate;

    MYSQL_RES* res;
    MYSQL_ROW row;
    MYSQL* conn;
    string fetch(int some)
    {
    	std::string s1 = SSTR( some );
    	query.clear();
    	query="select * from banks where uid="+s1+"";
        mysql_query(conn,query.c_str());
        res = mysql_store_result(conn);
        while((row=mysql_fetch_row(res)))
        {
            rec+="| ACCOUNT ID : "+string(row[0])+"|NAME : "+string(row[1])+"|ACC TYPE : "+string(row[2])+"|CURRENT BALANCE : "+string(row[3])+"|\n";
        }
        return rec;
    }

    void dbcheck();
	void add_acc();
	void view_acc();
	void deposit();
	void withdraw();
	void balance();
	void acList();
	void close();
	void modify();


};
string suno::query="";
string suno::dat="";

    void suno::dbcheck()
    {

       query="CREATE TABLE IF NOT EXISTS banks (uid int(11) NOT NULL AUTO_INCREMENT,uname varchar(255) NOT NULL,ustatus varchar(255) DEFAULT NULL,bal_amt int(11) NOT NULL,PRIMARY KEY (uid)) ENGINE=MyISAM DEFAULT CHARSET=latin1";
       qstate+= mysql_query(conn,query.c_str());
        query="CREATE TABLE IF NOT EXISTS transhis (tid int(11) NOT NULL,tamt int(11) NOT NULL,tstatus varchar(100) NOT NULL,tdate varchar(200) NOT NULL,KEY tid (tid)) ENGINE=MyISAM DEFAULT CHARSET=latin1";
        qstate+= mysql_query(conn,query.c_str());
        qstate==0 ? cout<<starp(20,"=")<<"All working fine :)"<<starp(20,"=") : cout<<starp(20,"=")<<"Contact your Developer !!"<<starp(20,"=");
    }
  void suno::add_acc()
    {
        system("cls");
       cin.ignore();
        cout<<"\nEnter Your Name : ";getline(cin,nam);cout<<endl;
        cout<<"Enter Your Account Type : ";getline(cin,addr);cout<<endl;
        cout<<"Enter balance Amount : ";cin>>bal;cout<<endl;
        try{
        query="insert into banks (uname,ustatus,bal_amt) values ('"+string(nam)+"','"+string(addr)+"',"+ SSTR(bal)+")";
        qstate = mysql_query(conn,query.c_str());
        qstate==0 ? cout<<starp(20,"=")<<"Data has been uploaded to Server.. :)"<<starp(20,"=") : cout<<starp(20,"=")<<"Something is Wrong..."<<starp(20,"=");
         }
         catch (const std::exception& e) { // reference to the base of a polymorphic object
              std::cout << e.what(); // information from length_error printed
         }


         system("pause");
    }


    void suno::view_acc()
    {
        system("cls");
    try{

        string str = "Select * From banks";

       qstate = mysql_query(conn,str.c_str());
       qstate==0 ? cout<<starp(20,"=")<<"Data has been uploaded to Server.. :)"<<starp(20,"=") : cout<<starp(20,"=")<<"Something is Wrong...\n"<<starp(20,"=");
        res = mysql_store_result(conn);
           cout<<"\n\t|\t ACCOUNT ID"<<"\t|\t"
            <<"NAME"<<"\t|\t"
            <<"ACC TYPE"<<"\t|\t"
            <<"CURRENT BALANCE"<<"\t|\t\n";

        while((row=mysql_fetch_row(res)))
        {
            cout<<"\n\t|\t"<<row[0]<<"\t|\t"
            <<""<<row[1]<<"\t|\t"
            <<""<<row[2]<<"\t|\t"
            <<""<<row[3]<<"\t|\t\n";
        }
       }
    catch (...) { /* reference to the base of a polymorphic object*/}
    system("pause");
    }



    void suno::deposit()
    {
        system("cls");
        cout<<"Enter Account Number : ";
        cin>>ac;
        cout<<fetch(ac)<<endl;
        cout<<"Enter Amount to deposit : ";
        cin>>amm;
        query="update banks set bal_amt=(bal_amt+"+ SSTR(amm) +") where uid="+ SSTR(ac) +" ";
        qstate = mysql_query(conn,query.c_str());
        qstate==0 ? cout<<"Data has been uploaded to Server.. :)" : cout<<"Something is Wrong...\n";
        query="insert into transhis (tid,tamt,tstatus,tdate) values ("+SSTR(ac)+","+SSTR(amm)+",'credited','"+dat+"')";
        qstate = mysql_query(conn,query.c_str());
        qstate==0 ? cout<<"Data has been uploaded to Server.. :)" : cout<<"Something is Wrong...\n";
        system("pause");
    }


    void suno::withdraw()
    {
        system("cls");
        cout<<"Enter Account Number : ";
        cin>>ac;
        cout<<fetch(ac)<<endl;
        cout<<"Enter Amount to withdraw : ";
        cin>>amm;
        query="update banks set bal_amt=(bal_amt-"+SSTR(amm)+") where uid="+SSTR(ac)+" ";
        qstate = mysql_query(conn,query.c_str());
        qstate==0 ? cout<<"Data has been uploaded to Server.. :)" : cout<<"Something is Wrong...\n";
        query="insert into transhis (tid,tamt,tstatus,tdate) values ("+SSTR(ac)+","+SSTR(amm)+",'deducted','"+dat+"')";
        qstate = mysql_query(conn,query.c_str());
        qstate==0 ? cout<<"Data has been uploaded to Server.. :)" : cout<<"Something is Wrong...\n";
        system("pause");
    }


    void suno::balance()
    {
        system("cls");
        cout<<"Enter Account Number : ";
        cin>>ac;
        cout<<fetch(ac);
        cout<<starp(30,"=")<<"Transaction History"<<starp(30,"=")<<endl;
        query="select * from transhis WHERE tid="+SSTR(ac)+"";
        mysql_query(conn,query.c_str());
        res = mysql_store_result(conn);
        cout<<"|\tACCOUNT ID\t"<<"|"
            <<"\tAMOUNT\t"<<"|"
            <<"\tSTATUS\t"<<"|"
            <<"\tDATE\t"<<"|\n";
        while((row=mysql_fetch_row(res)))
        {
            cout<<"|\t"<<row[0]<<"|"
            <<row[1]<<"|\t"
            <<row[2]<<"|\t"
            <<row[3]<<"|\n";
        }


        system("pause");
    }


    void suno::acList()
    {
        system("cls");
        mysql_query(conn,"select * from banks");
        res = mysql_store_result(conn);
        cout<<"| ACCOUNT ID"<<"|"
            <<"NAME"<<"|"
            <<"ACC TYPE"<<"|"
            <<"CURRENT BALANCE"<<"|\n";
        while((row=mysql_fetch_row(res)))
        {
            cout<<"\t|\t"<<row[0]<<"\t|\t"
            <<row[1]<<"\t|\t"
            <<row[2]<<"\t|\t"
            <<row[3]<<"\t|\t\n";
        }
        system("pause");
    }


    void suno::close()
    {
        system("cls");
        cout<<"Enter Account Number";
        cin>>ac;
        query="delete from transhis where tid="+SSTR(ac)+"";

        qstate=mysql_query(conn,query.c_str());

        query="delete from banks where uid="+SSTR(ac)+"";

        qstate= mysql_query(conn,query.c_str());
        qstate==0 ? cout<<"\n"+SSTR(ac)+"Account details has been deleted from Server.. :)\n" : cout<<"Something is Wrong...\n";
        system("pause");
    }

    void suno::modify()
    {
        system("cls");
        cout<<"Enter Account Number : ";
        cin>>ac;
        fetch(ac);
        cout<<"Enter \".\" (dot) if you dont want to make changes to data ..";
        cin.ignore();
        cout<<"\nEnter Your Name : ";getline(cin,nam);cout<<endl;
        if(nam!=".")
        {
            query="update banks set uname='"+string(nam)+"' where uid="+SSTR(ac)+"";
            qstate = mysql_query(conn,query.c_str());
        }

        cout<<"Enter Your Account Type : ";getline(cin,addr);cout<<endl;
        if(addr!=".")
        {
            query="update banks set ustatus='"+string(addr)+"' where uid="+SSTR(ac)+"";
            qstate+= mysql_query(conn,query.c_str());
        }

        cout<<"Enter balance Amount : ";cin>>bal;cout<<endl;
        if(cin.fail()==false)
        {
            query="update banks set bal_amt="+SSTR(bal)+" where uid="+SSTR(ac)+"";
            qstate+= mysql_query(conn,query.c_str());

        }
        cin.clear();cin.ignore();
        qstate==0 ? cout<<"Data has been uploaded to Server.. :)" : cout<<"Something is Wrong...\n";
        system("pause");
    }


int main(int argc, char** argv)
{

    system("color f8");
    suno a;
    int a1;

    struct tm *newtime;
    time_t ltime;

/* Get the time in seconds */
    time(&ltime);
/* Convert it to the structure tm */
    newtime = localtime(&ltime);
    suno::dat=asctime(newtime);//assigning date value o static string

 string host = "localhost";
    string user = "root";
    string pass = "manish";
    string db = "bank";
/*
  string host = "mysql.hostinger.in";
  string user = "u781539011_bank";
  string pass = "c++data";
   string db = "u781539011_banks";
*/
   // a.conn;//connection Pointer

   a.conn = mysql_init(0);
 try{
    a.conn=mysql_real_connect(a.conn,host.c_str(), user.c_str(), pass.c_str(), db.c_str(), 0, NULL, 0);
    a.dbcheck();
    }
    catch (const std::exception& ee)
    {
        cout << "Standard exception: " << ee.what() << endl;
    }
if (a.conn)
         cout << starp(60,"=")<<"Connection ok!" << starp(60,"=")<< endl;
    else {
         cout <<starp(60,"=")<< "Connection fail: " << mysql_error(a.conn) <<starp(60,"=")<< endl;
    }

   do
   {
    system("cls");
    cout<<starp(100,"*")<<"\nEnter your Choice....."<<endl
    <<"\t 1) Add Account"<<endl
    <<"\t 2) View Account"<<endl
    <<"\t 3) Deposit Amount"<<endl
    <<"\t 4) Withdraw Amount"<<endl
    <<"\t 5) Balance Inquiry"<<endl
    <<"\t 6) All Account Holder List"<<endl
    <<"\t 7) Close an Account"<<endl
    <<"\t 8) Modify an Account"<<endl
    <<"\t 9) Exit"<<endl<<starp(100,"*")<<endl;
    cin>>a1;
    try{
        switch(a1)
            {
                case 1: a.add_acc();break;
                case 2:a.view_acc();break;
                case 3: a.deposit();break;
                case 4: a.withdraw();break;
                case 5: a.balance();break;
                case 6: a.acList();break;
                case 7: a.close();break;
                case 8: a.modify();break;
                case 9: exit(0); break;
                default:cout<<"Plz enter Number from Given Option ONLY..";break;
            }

    }
        catch (const std::exception& e)
        {
            cout << "Standard exception: " << e.what() << endl;
        }
    }while(a1!=9);



return 0;
}

